jobs:
  fmt:
    command: black . --exclude venv
    targets:
      - all

  yenv:
    function: yenv:main
    context:
      yenv-file: ../environment.yml
      env-targets:
        - {{name}}

{% if package %}
  clean:
    function: clean:main
    context:
      clean_dirs:
        - build
        - dist
        - {{src}}.egg-info

  pypi-upload:
    function: pypi_upload:main
    context:
      release_type: patch
      twine_username: {{twine_username}}

  purge:
    command: purge .
    context:
      twine_username: {{twine_username}}
{% endif %}
{% if server %}
  build:
    function: build:main
    targets: 
      - {{server}}
{% endif %}
{% if webapp %}
  multi-stage-build:
    function: multi_stage_build:main
    context:
      build_stage_prefix: build
    targets: 
      - {{webapp}}

  deploy:
    function: deploy:main
    context:
      deploy_target: {{deploy_url}}
      remote_user: root
      docker_compose_file: docker-compose.yml
      version: {{version}}
      image_names:
        - {{webapp}}
{% if server %}
        - {{server}}
{% endif %}
{% endif %}

projects:
{% if package %}
  {{src}}:
    path: ../{{src}}
{% endif %}
{% if webapp %}
  {{webapp}}:
    path: ../{{webapp}}
    context:
      image_name: {{webapp}}
      version: {{version}}
{% endif %}
{% if webapp %}
  {{server}}:
    path: ../{{server}}
    context:
      image_name: {{server}}
      version: {{version}}
{% endif %}

routines:
{% if package %}
  release:
    - fmt
    - clean
    - pypi-upload
{% endif %}
{% if webapp %}    
  deploy:
    - fmt
    - clean
    - build
    - multi-stage-build
    - deploy
{% endif %}
